- 本教程视频链接地址：https://www.bilibili.com/video/av81497003/

- 本教程gitee上地址：https://gitee.com/advance/tutorial-laravel

- 本教程github上地址：https://github.com/youshengyouse/tutorial-laravel

  

##  ![laravel_002_a](./imgs_tutorials/laravel_002_env.jpg)

# 预备知识

- 由于安全原因，在php.ini中设置`variables_order = "GPCS"` 并没有打开`$_ENV`这个超级全局变量，所以在php中`$_ENV`的值为空数组，如果想获取系统变量，如PATH的值，只能通过 getenv('PATH')的方式读取，`$_ENV['PATH']`是读取不到的。
- 在php中以`$_ENV['zhang']='张';`形式往里面添加的数据,可以使用`$_ENV['zhang']`的方式读取的。
- 在php中以 `putenv('li=李');`形式添加的变量，只能使用`getenv('li');`的方式读取，`$_ENV['li']`是读取不到的
- 在laravel引入库`vlucas/phpdotenv`，使用它将环境文件(.env等)添加到`$_ENV`中

# 应用环境

- 指的是`$app['env'] `的值，它的取值默认有 `testing`,`production`,`local`三种，它是在当前环境文件(.env等)中`APP_ENV`的值，实际上可以为任意值

 ```
  $app->runningUnitTests() 判断$app['env'](其实就当前环境文件中APP_ENV)的值是否为testing
  $app->isProduction() 判断$app['env']的值是否为production
  $app->isLocal() 判断$app['env']的值是否为local
  $app->environment() 获取$app['env']的值
  $app->environment('home') 支持正则，判断APP_ENV的值是否为home
 ```

查看应用环境的console中的命令是:  `$ php artisan env`

查看应用环境的web的方法是:  `$app->environment()`,只能加载环境变量完成之后才能读取

# 当前工作环境

- 环境文件是放在**环境目录**下，环境目录是通过`$app->useEnvironmentPath($path)`来设置，默认为基本目录
- 如果没有指定当前工作环境，或者没有定义相应的环境文件，环境文件就是`.env`，如果指定了当前工作环境为`dev`，且`环境目录/.env.dev`存在，laravel就会将`环境目录/.env.dev`中的配置储存到`$_ENV`中

# 设置当前工作环境的几种方法

- 在操作系统中，使用export APP_ENV=home

- docker-compose.yml中 

 ```
   environment:
    APP_ENV: home
 ```
- `docker-compose.yml` 中 `build.env_file`中指定
- 在`.bashrc`中也可以指定
- 在Dockerfile中的使用 `ENV  APP_ENV  home`
- 在nginx配置文件中, fastcgi_param APP_ENV home;
- 最简单的方式是在入口文件`artisan`或`public/index.php`中指定 `putenv("APP_ENV=home");`，我就是用这种方式，随时可以修改
- apache也可以在配置文件或.htaccess文件配置

# 建议

实际工作中设置顺序是：

1. 在index.php或artisan中使用当前工作环境，如`putenv("APP_ENV=dev");`

2. 新建或从.env.example复制，建立相应的环境文件 .env.dev，可以一次性将多个环境文件建好配置好，用时只在入口文件中切换，在入口文件中也可以将几种环境定义成数组，如 
  ```
  $env = ['home','company','dev','prod'];
  putenv("APP_ENV=$env[2]");    
  ```



# 要搞明白

当前工作环境与应用环境的关系？

环境文件中的配置添加到`$_ENV`是什么时间点？是在$app实例化,$request实例化后，在Kernel bootstrap阶段，它是第1个执行，在它之后就可以读取`$_ENV`中的值，所以配置文件中可以用，服务提供商中也可以用，当然中间件中也可以用，视图，控制器，模型中都可以。

```
1. 加载环境变量    LoadEnvironmentVariables
2. 加载配置       LoadConfiguration
3. 处理异常       HandleExceptions
4. 注册Facade    RegisterFacades
5. 注册服务提供商  RegisterProviders
6. 启动服务提供商  BootProviders
```

助手函数 env('属性',‘默认值’)





# 给我来杯“茶颜悦色”

![pay](./imgs_tutorials/pay.jpg)